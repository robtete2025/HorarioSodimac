<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MALLA DE TRABAJADORES</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #app, #logoutBtn { display: none; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    input { width: 70px; }
    button { margin-right: 10px; }
    .resaltado { background-color: yellow; font-weight: bold; }
  </style>
</head>
<body>

<div id="login">
  <h2>Iniciar sesi√≥n</h2>
  <input id="clave" type="password" placeholder="Clave" />
  <button onclick="iniciarSesion()">Entrar</button>
</div>

<div id="app">
  <h2>MALLA DE TRABAJADORES</h2>
  <input id="busqueda" type="text" placeholder="Buscar trabajador..." oninput="mostrarTabla()" />
  <div style="margin-top:10px;">
    <button id="btnAgregar" onclick="agregarTrabajador()">Agregar trabajador</button>
    <button id="btnExportar" onclick="exportarExcel()">Exportar Excel</button>
    <button id="logoutBtn" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </div>
  <div id="tabla"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC2DQQwIHLYwGTJWPfb5aYVpT_gYNrrDt0",
    authDomain: "horarioapp-70a6c.firebaseapp.com",
    projectId: "horarioapp-70a6c",
    storageBucket: "horarioapp-70a6c.firebasestorage.app",
    messagingSenderId: "723849222277",
    appId: "1:723849222277:web:2ecaac953a4c33b86031ec"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const DIAS = ["lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado", "domingo"];
  const CLAVES = { jefe: "sodimac", viewer: "plazanorte" };

  let rol = null;
  let trabajadores = [];

  window.iniciarSesion = async function () {
    const claveInput = document.getElementById("clave").value.trim();
    if (claveInput === CLAVES.jefe) rol = "jefe";
    else if (claveInput === CLAVES.viewer) rol = "viewer";
    else return alert("Clave incorrecta");

    localStorage.setItem("rol", rol);
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";

    await cargarTrabajadores();
    mostrarTabla();
    mostrarBotonesSegunRol();
  };

  window.cerrarSesion = function () {
    localStorage.removeItem("rol");
    rol = null;
    trabajadores = [];
    document.getElementById("login").style.display = "block";
    document.getElementById("app").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("clave").value = "";
  };

  function mostrarBotonesSegunRol() {
    document.getElementById("btnAgregar").style.display = rol === "jefe" ? "inline-block" : "none";
    document.getElementById("btnExportar").style.display = rol === "jefe" ? "inline-block" : "none";
  }

  async function cargarTrabajadores() {
    const q = query(collection(db, "trabajadores"), orderBy("nombre"));
    const querySnapshot = await getDocs(q);
    trabajadores = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  }

  window.agregarTrabajador = async function () {
    const nombre = prompt("Nombre del trabajador:");
    if (!nombre?.trim()) return;
    const docRef = await addDoc(collection(db, "trabajadores"), {
      nombre: nombre.trim(), horario: {}, fechas: {}
    });
    trabajadores.push({ id: docRef.id, nombre: nombre.trim(), horario: {}, fechas: {} });
    trabajadores.sort((a, b) => a.nombre.localeCompare(b.nombre));
    mostrarTabla();
  };

  window.actualizarCampo = async function (index, dia, campo, valor) {
    const t = trabajadores[index];
    if (!t.horario) t.horario = {};
    if (!t.horario[dia]) t.horario[dia] = {};
    t.horario[dia][campo] = valor;
    await updateDoc(doc(db, "trabajadores", t.id), { horario: t.horario });
  };

  window.actualizarFecha = async function (index, dia, valor) {
    const t = trabajadores[index];
    if (!t.fechas) t.fechas = {};
    t.fechas[dia] = valor;
    await updateDoc(doc(db, "trabajadores", t.id), { fechas: t.fechas });
  };

  window.eliminarTrabajador = async function (index) {
    if (!confirm("¬øSeguro que quieres eliminar este trabajador?")) return;
    await deleteDoc(doc(db, "trabajadores", trabajadores[index].id));
    trabajadores.splice(index, 1);
    mostrarTabla();
  };

  function aplicarEstilo(texto) {
    return /libre|vacaciones/i.test(texto) ? "resaltado" : "";
  }

  window.mostrarTabla = function () {
    const filtro = document.getElementById("busqueda").value.toLowerCase();
    const tablaDiv = document.getElementById("tabla");

    const filtrados = trabajadores
      .filter(t => t.nombre.toLowerCase().includes(filtro))
      .sort((a, b) => a.nombre.localeCompare(b.nombre));

    let html = `<table><thead><tr><th>Nombre</th>`;
    DIAS.forEach(d => html += `<th>${d.charAt(0).toUpperCase() + d.slice(1)}<br><small>(D√≠a/Mes)</small></th>`);
    html += `<th>Acci√≥n</th></tr></thead><tbody>`;

    filtrados.forEach((t, i) => {
      html += `<tr><td>${t.nombre}</td>`;
      DIAS.forEach(d => {
        const h = t.horario?.[d] || {};
        const f = t.fechas?.[d] || "";
        if (rol === "jefe") {
          html += `<td>
            <input placeholder="D√≠a/Mes" value="${f}" onchange="actualizarFecha(${i}, '${d}', this.value)">
            <input class="${aplicarEstilo(h.entrada)}" placeholder="Entrada" value="${h.entrada || ''}" onchange="actualizarCampo(${i}, '${d}', 'entrada', this.value)">
            <input class="${aplicarEstilo(h.salida)}" placeholder="Salida" value="${h.salida || ''}" onchange="actualizarCampo(${i}, '${d}', 'salida', this.value)">
            <input class="${aplicarEstilo(h.refrigerio)}" placeholder="Refrigerio" value="${h.refrigerio || ''}" onchange="actualizarCampo(${i}, '${d}', 'refrigerio', this.value)">
            <input class="${aplicarEstilo(h.capacitacion)}" placeholder="Capacitaci√≥n" value="${h.capacitacion || ''}" onchange="actualizarCampo(${i}, '${d}', 'capacitacion', this.value)">
            <input class="${aplicarEstilo(h.lactancia)}" placeholder="Lactancia" value="${h.lactancia || ''}" onchange="actualizarCampo(${i}, '${d}', 'lactancia', this.value)">
          </td>`;
        } else {
          html += `<td>
            <div style="font-size:0.8em">${f}</div>
            Entrada: ${h.entrada || '-'}<br>Salida: ${h.salida || '-'}<br>Refrigerio: ${h.refrigerio || '-'}<br>
            Capacitaci√≥n: ${h.capacitacion || '-'}<br>Lactancia: ${h.lactancia || '-'}
          </td>`;
        }
      });
      html += rol === "jefe" ? `<td><button onclick="eliminarTrabajador(${i})">üóëÔ∏è</button></td>` : `<td>-</td>`;
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    tablaDiv.innerHTML = html;
  };

  window.exportarExcel = function () {
    alert("Funci√≥n exportar a√∫n no disponible.");
  };

  window.onload = async () => {
    const rolGuardado = localStorage.getItem("rol");
    if (rolGuardado === "jefe" || rolGuardado === "viewer") {
      rol = rolGuardado;
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("logoutBtn").style.display = "inline-block";
      mostrarBotonesSegunRol();
      await cargarTrabajadores();
      mostrarTabla();
    }
  };
</script>
</body>
</html>
